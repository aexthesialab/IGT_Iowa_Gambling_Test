<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>ÆX – Iowa Gambling Task</title>

    <style>
        body {
            margin: 0;
            background: #0d0d0d;
            color: #ffffff;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 40px 20px;
        }

        h1 {
            font-size: 40px;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 28px;
            margin-top: 30px;
            margin-bottom: 20px;
        }

        #intro {
            max-width: 900px;
            margin: 0 auto 30px auto;
            font-size: 18px;
            line-height: 1.6;
        }

        #statusBar {
            margin: 20px auto;
            max-width: 900px;
            display: flex;
            justify-content: space-between;
            font-size: 18px;
        }

        #statusBar div {
            margin: 0 10px;
        }

        #decks {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .deck {
            width: 160px;
            height: 240px;
            border-radius: 12px;
            background: linear-gradient(180deg, #1a1a1a, #101010);
            border: 2px solid #5fffd2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 18px 10px;
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
        }

        .deck.disabled {
            opacity: 0.35;
            cursor: default;
            border-color: #555555;
        }

        .deck:hover:not(.disabled) {
            transform: translateY(-4px);
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.55);
            background: linear-gradient(180deg, #262626, #111111);
        }

        .deck-label {
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .deck-info {
            font-size: 14px;
            color: #a0a0a0;
            max-width: 130px;
        }

        #feedback {
            font-size: 20px;
            margin-top: 20px;
            min-height: 40px;
        }

        .gain {
            color: #5fffd2;
        }

        .loss {
            color: #ff6f6f;
        }

        #startBtn {
            margin-top: 25px;
            font-size: 20px;
            padding: 12px 28px;
            background: #1b1b1b;
            border-radius: 8px;
            border: 2px solid #5fffd2;
            color: #5fffd2;
            cursor: pointer;
        }

        #startBtn:hover {
            background: #5fffd2;
            color: #000000;
        }

        #result {
            max-width: 900px;
            margin: 40px auto 0 auto;
            font-size: 18px;
            line-height: 1.6;
            text-align: left;
        }

        #result p {
            margin: 6px 0;
        }

        .badge-container {
            margin-top: 18px;
            margin-bottom: 10px;
        }

        .badge-label {
            font-size: 16px;
            margin-bottom: 6px;
        }

        .badge-pill {
            display: inline-block;
            padding: 8px 18px;
            border-radius: 999px;
            font-size: 16px;
            font-weight: bold;
        }

        .badge-good {
            background-color: #1f8a70;
            color: #ffffff;
        }

        .badge-normal {
            background-color: #b38f1b;
            color: #000000;
        }

        .badge-high {
            background-color: #b3261e;
            color: #ffffff;
        }

        .note {
            font-size: 12px;
            margin-top: 25px;
            color: #cccccc;
            text-align: center;
        }

        @media (max-width: 768px) {
            #statusBar {
                flex-direction: column;
                align-items: center;
                gap: 6px;
            }
        }
    </style>
</head>

<body>

<h1>Iowa Gambling Task</h1>

<div id="intro">
    In questo test parti con un credito iniziale. a ogni turno devi scegliere una carta da uno dei quattro mazzi (A, B, C, D).<br>
    Alcuni mazzi offrono guadagni elevati ma nascondono perdite maggiori sul lungo termine. altri mazzi offrono vincite più piccole ma con perdite contenute.<br><br>
    L’obiettivo è capire se nel tempo impari a privilegiare le scelte vantaggiose sul lungo periodo rispetto alla tentazione del guadagno immediato.
</div>

<button id="startBtn">Inizia il test</button>

<div id="statusBar" style="display:none;">
    <div>Prova. <span id="trialCounter">0</span> / <span id="totalTrialsLabel">0</span></div>
    <div>Saldo. <span id="balanceLabel">0</span> $</div>
</div>

<div id="decks" style="display:none;">
    <div class="deck" id="deckA" data-deck="A">
        <div class="deck-label">A</div>
        <div class="deck-info">
            Guadagni alti, perdite imprevedibili.<br>
            Potenzialmente svantaggioso nel tempo.
        </div>
    </div>

    <div class="deck" id="deckB" data-deck="B">
        <div class="deck-label">B</div>
        <div class="deck-info">
            Guadagni alti, perdite meno frequenti ma pesanti.<br>
            Potenzialmente svantaggioso nel tempo.
        </div>
    </div>

    <div class="deck" id="deckC" data-deck="C">
        <div class="deck-label">C</div>
        <div class="deck-info">
            Guadagni moderati, perdite più piccole.<br>
            Generalmente vantaggioso.
        </div>
    </div>

    <div class="deck" id="deckD" data-deck="D">
        <div class="deck-label">D</div>
        <div class="deck-info">
            Guadagni moderati, perdite rare e contenute.<br>
            Generalmente vantaggioso.
        </div>
    </div>
</div>

<div id="feedback"></div>

<div id="result"></div>

<script>
/* ------------------------------
   CONFIGURAZIONE
--------------------------------*/

// sostituisci con la URL della tua Web App Google Apps Script
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzrEyBwr8yNM3k9UqoTvmbBdXZa1PmkSOJabxjhG_qCuSUmcP5ZRM1OeqpVYAZKOutr/exec";

const NUM_TRIALS = 100;
const START_BALANCE = 2000;

// config dei mazzi. payoff deterministici su cicli di 10 carte
// A e B. svantaggiosi. C e D. vantaggiosi

const deckConfigs = {
    A: {
        label: "A",
        gain: 100,
        losses: [0, 0, 150, 0, 300, 0, 0, 200, 0, 400] // somma perdite 1050 . net = -50 ogni 10
    },
    B: {
        label: "B",
        gain: 100,
        losses: [0, 0, 0, 0, 1250, 0, 0, 0, 0, 0] // una perdita molto alta
    },
    C: {
        label: "C",
        gain: 50,
        losses: [0, 25, 0, 25, 0, 25, 0, 25, 0, 25] // somma perdite 125 . net +375 ogni 10
    },
    D: {
        label: "D",
        gain: 50,
        losses: [0, 0, 0, 50, 0, 0, 0, 50, 0, 0] // perdite rare
    }
};

/* ------------------------------
   STATO
--------------------------------*/

let sessionId = null;
let currentTrial = 0;
let balance = START_BALANCE;

let deckPointers = { A: 0, B: 0, C: 0, D: 0 };

let deckChoices = { A: 0, B: 0, C: 0, D: 0 };

let trialLog = []; // per analisi dettagliata

// net score per blocchi da 20 prove
let blockNetScore = [0, 0, 0, 0, 0]; // 5 blocchi da 20

let testRunning = false;

/* ------------------------------
   UTILITY
--------------------------------*/

function interpretIGT(netScore, blockScores) {
    // logica semplice. soglie educative, non cliniche
    const lastBlock = blockScores[4];

    if (netScore >= 20 && lastBlock > 0) {
        return {
            label: "Buona capacità di privilegiare vantaggio a lungo termine rispetto al guadagno immediato",
            cssClass: "badge-good"
        };
    } else if (netScore >= 0) {
        return {
            label: "Performance nella norma. equilibrio tra scelte rischiose e conservative",
            cssClass: "badge-normal"
        };
    } else {
        return {
            label: "Tendenza a privilegiare ricompense immediate anche a costo di perdite future",
            cssClass: "badge-high"
        };
    }
}

function updateStatusBar() {
    document.getElementById("trialCounter").innerText = currentTrial;
    document.getElementById("balanceLabel").innerText = balance.toString();
}

function setDecksEnabled(enabled) {
    const decks = document.querySelectorAll(".deck");
    decks.forEach(d => {
        if (enabled) {
            d.classList.remove("disabled");
        } else {
            d.classList.add("disabled");
        }
    });
}

/* ------------------------------
   GESTIONE TEST
--------------------------------*/

function startTest() {
    sessionId = "AEX-" + Date.now();
    currentTrial = 0;
    balance = START_BALANCE;
    deckPointers = { A: 0, B: 0, C: 0, D: 0 };
    deckChoices = { A: 0, B: 0, C: 0, D: 0 };
    trialLog = [];
    blockNetScore = [0, 0, 0, 0, 0];
    testRunning = true;

    document.getElementById("totalTrialsLabel").innerText = NUM_TRIALS.toString();
    document.getElementById("statusBar").style.display = "flex";
    document.getElementById("decks").style.display = "flex";
    document.getElementById("feedback").innerHTML = "";
    document.getElementById("result").innerHTML = "";

    updateStatusBar();
    setDecksEnabled(true);
}

function endTest() {
    testRunning = false;
    setDecksEnabled(false);

    const totalAdvantageous = deckChoices.C + deckChoices.D;
    const totalDisadvantageous = deckChoices.A + deckChoices.B;
    const netScore = totalAdvantageous - totalDisadvantageous;

    const interpretation = interpretIGT(netScore, blockNetScore);

    // dettaglio blocchi
    const blockDetails = blockNetScore.map((val, idx) => {
        const startTrial = idx * 20 + 1;
        const endTrial = (idx + 1) * 20;
        return `<li>Blocchi prove ${startTrial}–${endTrial}. Net score. ${val}</li>`;
    }).join("");

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = `
        <h2>Risultati</h2>

        <p><strong>Saldo iniziale. </strong>${START_BALANCE} $</p>
        <p><strong>Saldo finale. </strong>${balance} $</p>
        <p><strong>Scelte mazzi svantaggiosi (A+B). </strong>${totalDisadvantageous}</p>
        <p><strong>Scelte mazzi vantaggiosi (C+D). </strong>${totalAdvantageous}</p>
        <p><strong>Net score complessivo (C+D) − (A+B). </strong>${netScore}</p>

        <div class="badge-container">
            <div class="badge-label">Sintesi del tuo profilo in questo test</div>
            <div class="badge-pill ${interpretation.cssClass}">
                ${interpretation.label}
            </div>
        </div>

        <h3>Andamento nel tempo</h3>
        <ul>${blockDetails}</ul>

        <p class="note">
            I dati di questo test sono salvati in forma anonima e aggregata.  
            non raccogliamo nome, email o altri dati che permettano l'identificazione personale.  
            il tuo codice di sessione è <strong>${sessionId}</strong> e viene usato solo per analisi statistiche interne.
        </p>
    `;

    sendSummaryToSheet(netScore, blockNetScore);
}

function handleDeckClick(deckId) {
    if (!testRunning) return;
    const config = deckConfigs[deckId];
    if (!config) return;

    currentTrial++;
    if (currentTrial > NUM_TRIALS) {
        return;
    }

    const lossSchedule = config.losses;
    const pointer = deckPointers[deckId] % lossSchedule.length;
    const loss = lossSchedule[pointer];
    deckPointers[deckId]++;

    const gain = config.gain;
    const netGain = gain - loss;
    balance += netGain;

    deckChoices[deckId]++;

    // blocco corrente (0–4)
    const blockIndex = Math.floor((currentTrial - 1) / 20);
    const isAdvantageous = (deckId === "C" || deckId === "D");
    const isDisadvantageous = (deckId === "A" || deckId === "B");

    if (isAdvantageous) {
        blockNetScore[blockIndex] += 1;
    } else if (isDisadvantageous) {
        blockNetScore[blockIndex] -= 1;
    }

    trialLog.push({
        trial: currentTrial,
        deck: deckId,
        gain: gain,
        loss: loss,
        netGain: netGain,
        balance: balance,
        blockIndex: blockIndex + 1
    });

    const feedbackDiv = document.getElementById("feedback");
    feedbackDiv.innerHTML = `
        Hai scelto il mazzo <strong>${deckId}</strong>. 
        <span class="gain">+${gain} $</span> 
        ${loss > 0 ? `<span class="loss">, perdita. −${loss} $</span>` : ""} 
        <br>Variazione netta. <strong>${netGain >= 0 ? "+" + netGain : netGain} $</strong>. 
        Saldo attuale. <strong>${balance} $</strong>.
    `;

    updateStatusBar();

    if (currentTrial >= NUM_TRIALS) {
        endTest();
    }
}

/* ------------------------------
   INVIO A GOOGLE SHEET
--------------------------------*/

function sendSummaryToSheet(netScore, blockScores) {
    const payload = {
        sessionId: sessionId,
        totalTrials: NUM_TRIALS,
        startBalance: START_BALANCE,
        finalBalance: balance,
        deckA_choices: deckChoices.A,
        deckB_choices: deckChoices.B,
        deckC_choices: deckChoices.C,
        deckD_choices: deckChoices.D,
        netScore: netScore,
        block1_netScore: blockScores[0],
        block2_netScore: blockScores[1],
        block3_netScore: blockScores[2],
        block4_netScore: blockScores[3],
        block5_netScore: blockScores[4],
        extra: ""
    };

    // se in futuro vuoi log trial per trial puoi inviare anche trialLog con una seconda web app
    fetch(WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload)
    }).catch(err => {
        console.error("Errore nell'invio al foglio Google:", err);
    });
}

/* ------------------------------
   EVENTI UI
--------------------------------*/

document.getElementById("startBtn").addEventListener("click", () => {
    startTest();
});

["A", "B", "C", "D"].forEach(deckId => {
    const elementId = "deck" + deckId;
    document.getElementById(elementId).addEventListener("click", () => {
        handleDeckClick(deckId);
    });
});
</script>

</body>
</html>
